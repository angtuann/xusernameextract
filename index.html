<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X Username Extractor + Comment Checker</title>
  <style>
    body { font-family: sans-serif; background: #0b0d10; color: #e5e7eb; margin: 0; padding: 20px; }
    h1 { margin: 0 0 10px 0; }
    textarea, input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #444; background: #111; color: #eee; }
    .btn { background: #22d3ee; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; margin-top: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; background: #111; }
    th, td { padding: 6px 10px; border: 1px solid #333; font-size: 14px; }
    th { background: #222; }
    .ok { color: #34d399; }
    .warn { color: #f59e0b; }
  </style>
</head>
<body>
  <h1>X Username Extractor + Comment Checker</h1>
  <p>Dán link bài viết X/Twitter, tool sẽ lọc ra <b>username</b> và <b>tweet ID</b>. Sau đó bạn có thể kiểm tra xem họ đã comment vào bài viết của bạn hay chưa.</p>

  <textarea id="input" placeholder="Dán list link ở đây..."></textarea>
  <button id="btnExtract" class="btn">Trích xuất</button>

  <div style="margin-top:12px">
    <input id="bearer" placeholder="Bearer Token (API v2)" />
  </div>
  <div style="margin-top:12px">
    <input id="targetTweet" placeholder="Nhập Tweet ID bài viết của bạn" />
    <button id="btnCheckReplies" class="btn">Check Comment</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Original URL</th>
        <th>Username</th>
        <th>Tweet ID</th>
        <th>Replied</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

<script>
const input = document.getElementById('input');
const btnExtract = document.getElementById('btnExtract');
const btnCheckReplies = document.getElementById('btnCheckReplies');
const tableBody = document.getElementById('tableBody');
const bearerInput = document.getElementById('bearer');
const targetTweet = document.getElementById('targetTweet');

let results = [];

function parseUrl(raw){
  try{
    let s = raw.trim();
    if(!/^https?:\/\//i.test(s)) s = 'https://' + s;
    const u = new URL(s);
    const parts = u.pathname.split('/').filter(Boolean);
    if(parts.length>=3 && parts[1]==='status'){
      return { original: raw, username: parts[0], tweet_id: parts[2] };
    }
  }catch(e){}
  return { original: raw, username: '', tweet_id: '' };
}

function extract(){
  const lines = input.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  results = lines.map(parseUrl).map((r,i)=>({...r, idx:i+1}));
  render();
}

function render(){
  tableBody.innerHTML = '';
  for(const r of results){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.idx}</td>
      <td><a href="${r.original}" target="_blank">${r.original}</a></td>
      <td>@${r.username||''}</td>
      <td>${r.tweet_id||''}</td>
      <td>${r.replied===true ? '<span class="ok">Yes</span>' : (r.replied===false ? '<span class="warn">No</span>' : '')}</td>
    `;
    tableBody.appendChild(tr);
  }
}

async function checkReplies(){
  const tweetId = targetTweet.value.trim();
  const token = bearerInput.value.trim();
  if(!tweetId){ alert("Nhập Tweet ID"); return; }
  if(!token){ alert("Nhập Bearer Token"); return; }

  for(let r of results){
    if(!r.username) continue;
    const uname = r.username.replace(/^@/,'');
    try {
      const url = `https://api.twitter.com/2/tweets/search/recent?query=conversation_id:${tweetId} from:${uname} -is:retweet -is:quote&max_results=10&tweet.fields=author_id`;
      const resp = await fetch(url, { headers: { "Authorization": "Bearer " + token }});
      if(resp.ok){
        const data = await resp.json();
        if(data.data && data.data.length>0){
          r.replied = true;
        } else {
          r.replied = false;
        }
      } else {
        r.replied = false;
      }
    } catch(e){
      r.replied = false;
    }
    render();
    await new Promise(res=>setTimeout(res,400)); // tránh rate limit
  }
}

btnExtract.addEventListener('click', extract);
btnCheckReplies.addEventListener('click', checkReplies);
</script>
</body>
</html>
